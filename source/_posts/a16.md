title: URLEncoder in JAVA
date: 2020-01-20
tags: [java]
toc: true
---

å‘ç°`Webclient`çš„`URLEncoder`çš„è¡¨ç°éå¸¸ä¸ç¨³å®šï¼Œæ‰€ä»¥æ‰¾äº†ä¸€ä¸‹æ­£ç¡®çš„ä½¿ç”¨æ–¹å¼ï¼Œé¦–å…ˆæ˜¯ä¸€ä¸ªissue [TestRestTemplate does the url encoding twice if I pass the URI as a string Â· Issue #8888 Â· spring-projects/spring-boot Â· GitHub](https://github.com/spring-projects/spring-boot/issues/8888) ï¼Œä¸€ä¸ªè€å“¥å‘ç°å½“`exchange` é‡Œä¼ å…¥ `URI` ç±»çš„æ—¶å€™ï¼Œ`exchange`ä¸ä¼šæœ‰ä»»ä½•encodeè¡Œä¸ºï¼Œä½†æ˜¯åœ¨ä¼ å…¥ä¸€ä¸ªå­—ç¬¦ä¸²çš„æ—¶å€™ä¼šè¢«encodeã€‚

ä¸‹é¢æœ‰`bclozel`çš„å›ç­”ğŸ‘‡ï¼š
```
Hi  [@georgmittendorfer](https://github.com/georgmittendorfer) ,
I think this is the expected behavior in Spring Framework (see  [SPR-16202](https://jira.spring.io/browse/SPR-16202)  and  [SPR-14828](https://jira.spring.io/browse/SPR-14828)  for some background on this).
As a general rule, providing a URI String to RestTemplate means that this String should be expanded (using optional method parameters) and then encoded. If you want to take full control over the encoding, you should then use the method variant taking a URI as a parameter.
The Spring Framework team recently added  [some more documentation on the subject of URI encoding](https://docs.spring.io/spring-framework/docs/current/spring-framework-reference/web.html#web-uri-encoding) . Does that help?
```

çœ‹æ¥Springè®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªæ­£å¸¸çš„è¡Œä¸ºï¼Œå³**ä¼ å…¥å­—ç¬¦ä¸²çš„æ—¶å€™æˆ‘å°±è¦å¯¹ä½ è¿›è¡Œencodeï¼Œä½ ä¼ URIå¯¹è±¡çš„æ—¶å€™æˆ‘ä¸ç®¡**ã€‚ç»§ç»­ç‚¹è¿›å»çœ‹çœ‹å®˜æ–¹æ–‡æ¡£ [Web on Servlet Stack](https://docs.spring.io/spring-framework/docs/current/spring-framework-reference/web.html#web-uri-encoding)ï¼š
1.5.3 ä¸­è¢«è¡¥ä¸Šäº†è¯¦ç»†çš„ä½¿ç”¨ç»†èŠ‚ï¼Œé¦–å…ˆå®ƒå°†`URI`çš„ç»„æˆåˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸€ä¸ªå«åš`URI template`ï¼Œä¸€ä¸ªå«åš`URI variables`ã€‚ç„¶åæä¾›äº†4ç§encodeçš„æ¨¡å¼ï¼š
+ `TEMPLATE_AND_VALUES`ï¼šä¼šå…ˆå¯¹templateè¿›è¡Œencodeï¼Œç„¶ååœ¨æ‰©å±•çš„æ—¶å€™å†å¯¹variablesè¿›è¡Œencodeã€‚
+ `VALUES_ONLY`ï¼šä¸ä¼šå¯¹templateè¿›è¡Œencodeï¼Œåœ¨æ‰©å±•ä¹‹å‰å¯¹variablesè¿›è¡Œencodeã€‚
+ `URI_COMPONENTS`ï¼šå’Œç¬¬äºŒç§ç±»ä¼¼ï¼Œä¸è¿‡æ˜¯åœ¨æ‰©å±•ä¹‹åå¯¹valuesè¿›è¡Œencodeã€‚
+ `NONE`ï¼šä¸åšä»»ä½•çš„encodeã€‚

å†æ¥çœ‹çœ‹æˆ‘ä»¬é‡åˆ°çš„é—®é¢˜ï¼Œåœ¨æˆ‘ä»¬çš„ä¸€ä¸ªåº“ä¸­ï¼Œç”¨é”™è¯¯çš„å§¿åŠ¿ä½¿ç”¨çš„`URI`ï¼š
```java
return webClient
    .get()
    .uri("/doItemHighCommissionPromotionLinkByAll?" + Utils.pojo2UrlQuery(request))
    .exchange();
```
ç›´æ¥ä¼ å…¥äº†ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä¼šå‘ç°è°ƒç”¨çš„æ–¹æ³•æ˜¯ï¼š
```java
@Override
public RequestBodySpec uri(String uriTemplate, Object... uriVariables) {
	attribute(URI_TEMPLATE_ATTRIBUTE, uriTemplate);
	return uri(uriBuilderFactory.expand(uriTemplate, uriVariables));
}
```
åŸæ¥æˆ‘ä»¬ä¼ å…¥çš„æ˜¯ä¸€ä¸ªæ²¡æœ‰ä»»ä½•å ä½ç¬¦çš„`uriTemplate`ï¼Œè€Œç°åœ¨ä¾èµ–çš„`WebClient`ç‰ˆæœ¬ä¸­é»˜è®¤çš„encodeæ¨¡å¼æ˜¯`EncodingMode.URI_COMPONENTS`ï¼Œä¹Ÿå°±æ˜¯æ ¹æœ¬ä¸ä¼šç®¡templateéƒ¨åˆ†ã€‚æ‰€ä»¥æˆ‘ä»¬å‘ç°ä¸ºä»€ä¹ˆä¼ å…¥ä¸€ä¸ªå­—ç¬¦ä¸²çš„æ—¶å€™æ²¡æœ‰è¢«è‡ªåŠ¨encodeã€‚

é‚£ä¹ˆæ˜¯ä¸æ˜¯æŠŠencodeæ¨¡å¼æ”¹ä¸º`EncodingMode. TEMPLATE_AND_VALUES`ï¼Œè®©å®ƒä¼šencode templateå°±æ²¡é—®é¢˜äº†å‘¢ï¼Ÿä¹Ÿä¸æ˜¯ï¼Œæ¯”å¦‚`http://api.vephp.com/hcapi?detail=1&vekey=V00003484Y95498091&para=https://uland.taobao.com/coupon/edetail?activityId=8932eb9980234090851d448195fe363c&itemId=578614572836`
è¿™ä¸ªurlï¼Œparaä¼ å…¥çš„åˆæ˜¯ä¸€ä¸ªurlï¼Œè·Ÿäº†ä¸€ä¸‹è§£æä»£ç ï¼Œä¼šå‘ç°templateåœ¨è§£æçš„æ—¶å€™ä¼šæŠŠquery mapè§£æˆï¼š
```json
{
	"detail": 1,
	"vekey": "V00003484Y95498091",
	"para": "https://uland.taobao.com/coupon/edetail?activityId=8932eb9980234090851d448195fe363c",
	"itemId": "578614572836"
}
```
å› ä¸ºå®ƒè§£æquery paramsçš„æ­£åˆ™é•¿è¿™æ ·ï¼š
```java
"([^&=]+)(=?)([^&]+)?"
```
æ‰€ä»¥åæœæ˜¯`para`ä¼šè¢«encodeï¼ˆè€Œä¸”è¿˜æ˜¯é”™è¯¯çš„encodeï¼Œè¿™æ˜¯ä¸€ä¸ªé’ˆå¯¹templateçš„encodeï¼Œä¸æ˜¯æ­£ç´§çš„urlEncodeï¼‰ï¼Œä½†æ˜¯`itemId`éƒ¨åˆ†ä¸ä¼šã€‚æ‰€ä»¥æœ€ç»ˆä¹Ÿåªæ˜¯å¾—åˆ°äº†ä¸€ä¸ªé”™è¯¯çš„encodeç»“æœã€‚

ç»¼ä¸Šæ‰€è¿°æœ‰ä¸‰ç§ä½¿ç”¨æ–¹å¼ï¼š
+ ä¼ å…¥çš„è¿˜æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä¸è¿‡åœ¨æ„é€ çš„æ—¶å€™è‡ªå·±å»åšurlEncodeï¼Œç„¶ååœ¨WebClientçš„è®¾ç½®é‡Œå°†encodeæ¨¡å¼è®¾ä¸ºåä¸‰ç§ã€‚
```java
return WebClient
    .builder()
    .exchangeStrategies(strategies)
    .baseUrl(endpoint)
    .uriBuilderFactory(providesUriBuilderFactory(endpoint));

private static DefaultUriBuilderFactory providesUriBuilderFactory(String endpoint) {
    DefaultUriBuilderFactory factory = new DefaultUriBuilderFactory(endpoint);
    factory.setEncodingMode(EncodingMode.NONE);
    return factory;
}
```

+ ä¼ å…¥ä¸€ä¸ª`URI`å¯¹è±¡ï¼Œæ„é€ çš„æ—¶å€™è‡ªå·±å»åšurlEncodeï¼Œä¸ç”¨å…³å¿ƒWebClienté‡Œçš„è®¾ç½®ã€‚
+ æ­£ç¡®çš„ä½¿ç”¨`url template`å’Œ`url variables`è¿›è¡Œæ„é€ ï¼Œé‚£å°±ä¸ç”¨è‡ªå·±å»åšurlEncodeã€‚
```java
URI uri = UriComponentsBuilder.fromPath("/hotel list/{city}")
        .queryParam("q", "{q}")
        .build("New York", "foo+bar")
```

æœ€åä½ å¯èƒ½ä¼šå‘ç°è‡ªå·±åœ¨è¿›è¡ŒurlEncodeçš„æ—¶å€™ï¼Œè¿˜æ˜¯ä¼šæœ‰é—®é¢˜ã€‚å¯ä»¥é˜…è¯»ä¸‹ [Java URL encoding: URLEncoder vs. URI - Stack Overflow](https://stackoverflow.com/questions/14321873/java-url-encoding-urlencoder-vs-uri) å’Œ  [Java equivalent to JavaScriptâ€™s encodeURIComponent that produces identical output? - Stack Overflow](https://stackoverflow.com/questions/607176/java-equivalent-to-javascripts-encodeuricomponent-that-produces-identical-outpu)
ç®€å•ç‚¹è¯´å°±æ˜¯ `URLEncoder.encode()` æ–¹æ³•ä¸æ˜¯ä½ çœŸæ­£æƒ³ç”¨åˆ°çš„æ–¹æ³•ï¼Œä½ å¯ä»¥è¿™æ ·ï¼š

```java
public static String encodeURIComponent(String s) {
    String result;

    try {
        result = URLEncoder.encode(s, "UTF-8")
                .replaceAll("\\+", "%20")
                .replaceAll("\\%21", "!")
                .replaceAll("\\%27", "'")
                .replaceAll("\\%28", "(")
                .replaceAll("\\%29", ")")
                .replaceAll("\\%7E", "~");
    } catch (UnsupportedEncodingException e) {
        result = s;
    }

    return result;
}
```
ï¼ˆå¥½å‚»å•Š